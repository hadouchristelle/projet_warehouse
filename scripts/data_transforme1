======================================================================
Script Purpose:
	This script recalculate sales if original value is missing or incorrect
	Derive price if original value is invalid
	check for invalide dates
	insert the data transformation  in the silver.crm_sales tables
use DataWarehouse;

------- check for invalide dates

select
nullif(sls_order_dt,0) sls_order_dt
from bronze.crm_sales
WHERE sls_order_dt < = 0 or LEN (sls_order_dt) != 8


--------------check for invalide date orders

INSERT INTO silver.crm_sales(
sls_ord_num ,
sls_prd_key ,
sls_cust_id,
sls_order_dt,
sls_ship_dt,
sls_due_dt ,
sls_sales,
sls_quantity,
sls_price)

SELECT DISTINCT
sls_sales as old_sls_sales,
sls_quantity,
sls_price as old_sls_price,

CASE WHEN sls_sales is null or  sls_sales < = 0 or sls_sales != sls_quantity * ABS(sls_price)
	THEN sls_quantity * ABS(sls_price)
	else sls_sales
END as sls_sales,
CASE WHEN sls_price is null or sls_price < = 0
	then sls_sales / nullif (sls_quantity,0)
	else sls_price
	end as sls_price
from bronze.crm_sales 
where sls_sales != sls_quantity * sls_price 
or sls_sales is null or sls_quantity  is null or sls_price is null
or sls_sales < = 0 or sls_quantity < = 0 or sls_price < = 0



----- transformation
INSERT INTO silver.crm_sales(
sls_ord_num ,
sls_prd_key ,
sls_cust_id,
sls_order_dt,
sls_ship_dt,
sls_due_dt ,
sls_sales,
sls_quantity,
sls_price)

SELECT 
sls_ord_num ,
sls_prd_key ,
sls_cust_id ,
CASE WHEN sls_order_dt = 0 or LEN (sls_order_dt) != 8 THEN NULL
		ELSE CAST (CAST(sls_order_dt as varchar) as DATE)
END AS sls_order_dt,

CASE WHEN sls_ship_dt = 0 or LEN (sls_ship_dt) != 8 THEN NULL
		ELSE CAST (CAST(sls_ship_dt as varchar) as DATE)
END AS sls_ship_dt,
CASE WHEN sls_due_dt = 0 or LEN (sls_due_dt) != 8 THEN NULL
		ELSE CAST (CAST(sls_due_dt as varchar) as DATE)
END AS sls_due_dt,
sls_sales ,
sls_quantity ,
sls_price 

fROM bronze.crm_sales
